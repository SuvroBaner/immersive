# This file tells Canvas what the app needs to run.

# 1. Identity & Metadata
# The Engine uses this to tag resources, setup cost allocation, and routing.
version: "v1"
kind: "CanvasService"
metadata:
  name: "text-service"
  description: "Generates immersive text descriptions from raw images and plain seller inputs"
  owner: "backend-team" # used for paging/alerts ownership
  cost_center: "ai-products" # used for AWS cost allocation tags

# 2. The Runtime Specification
spec:
  runtime: "python:3.12-slim"
  type: "backend-api" # This single line tells the engine to:
                      # - Create a Service
                      # - Setup standard security groups
                      # - Attach default middleware (e.g. rate limiting)
  
  # 3. Compute & Scaling (The "What")
  # Developers just ask for power; Engine handles node selection.
  compute:
    cpu_request: "500m"  # Half a core guaranteed (K8s requests)
    cpu_limit: "1000m"   # Burst up to 1 core, caps usage (K8s limits)
    memory_request: "512Mi"
    memory_limit: "1Gi"
    gpu: false           # Switch to true for image-service later
                         # Engine sees "false" -> schedules on standard nodes
                         # If 'true' -> schedules on GPU nodes + install NVIDIA drivers
    
    autoscaling:
      enabled: true
      min_replicas: 2    # High Availability Floor
      max_replicas: 10   # Cost ceiling
      target_cpu_utilization: 75 # The trigger for K8s HPA (Horizontal Pod Autoscaler)

  # 4. Networking
  networking:
    port: 8000
    public_access: true  # Engine creates an Ingress (ALB) (Ingress is a way to expose services outside the cluster via HTTP/HTTPS.) + DNS record
    health_path: "/"     # K8s Readiness/Liveness probes
    ingress_path: "/v1/text" # Routing rule

  # 5. Configuration (12-Factor App)
  env:
    # Non-sensitive configuration
    DEFAULT_PROVIDER: "gemini"
    MOCK_MODE: "false"
    LOG_LEVEL: "info"

  # 6. Secrets Management
  # Engine configures 'ExternalSecretsOperator' to fetch these from AWS
  # and inject them as env vars at runtime. No hardcoded secrets here.
  secrets:
    # These map to AWS Secrets Manager keys
    - key: "GOOGLE_API_KEY"
      source: "immersive/prod/text-service/google-key"

# 7. The Observability Plane (Alerting)
observability:
    metrics:
      enabled: true # Injects Datadog/Prometheus sidecar
    alerts:
      # Engine automatically creates CloudWatch/Datadog monitors for these
      on_high_error_rate:
        threshold: 1%
        window: 5m
        channel: "slack-backend-alerts"
      on_high_latency:
        threshold: 500ms
        p: 95 # 95th percentile

# # 8. The Security Plane (IAM Permissions)
# permissions:
#     # Engine creates an IAM Role for Service Account (IRSA) with these scopes
#     iam:
#       - effect: "allow"
#         action: ["s3:GetObject", "s3:PutObject"] # text-service might need to save images to S3
#         resource: "arn:aws:s3:::immersive-assets-bucket/*"

# # 9. Dependencies (Infrastructure as a Code)
# dependencies:
#     # Engine injects connection strings (REDIS_HOST, REDIS_PORT) into env
#     - name: "task-queue"
#       type: "redis"
#       version: "7.0"
#       tier: "standard"