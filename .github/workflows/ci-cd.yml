# This acts as the Integration & Delivery Plane. It ties everything together.

name: Canvas Pipeline (Text Service)

on:
  push:
    branches: [ main ]
    paths:
      - 'services/text-service/**'

env:
  SERVICE_NAME: text-service
  SERVICE_PATH: services/text-service

jobs:
  # --- CI STAGE: Quality & Security ---
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          pip install uv
          cd ${{ env.SERVICE_PATH }}
          uv pip install -r <(uv pip compile pyproject.toml)
          uv pip install pytest ruff

      - name: ðŸ” Linting (Ruff)
        run: |
          cd ${{ env.SERVICE_PATH }}
          python -m ruff check .

      - name: ðŸ§ª Unit Tests (Pytest)
        run: |
          cd ${{ env.SERVICE_PATH }}
          # Run in mock mode
          MOCK_MODE=true python -m pytest

      # Placeholder for Security Scans (Trivy/Sonar)
      - name: ðŸ›¡ï¸ Security Scan (Placeholder)
        run: echo "Running Trivy container scan..."

  # --- CD STAGE: Build & GitOps ---
  deploy:
    needs: verify
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      # 1. Build Docker Image
      - name: ðŸ³ Build Docker Image
        run: |
          docker build -t ${{ env.SERVICE_NAME }}:${{ github.sha }} ${{ env.SERVICE_PATH }}
          # In real life: docker push to ECR

      # 2. Install Canvas Engine
      - name: âš™ï¸ Install Canvas Engine
        run: |
          cd platform/engine
          pip install -r requirements.txt # (Assume generated from pyproject.toml)

      # 3. Run Canvas Engine (Hydrate Manifests)
      - name: ðŸŽ¨ Generate Kubernetes Manifests
        run: |
          python platform/engine/main.py generate ${{ env.SERVICE_PATH }} --image-tag ${{ github.sha }}

      # 4. GitOps Sync (Commit changes to Ops folder)
      - name: ðŸš€ GitOps Sync
        run: |
          git config --global user.name "Canvas Bot"
          git config --global user.email "bot@immersive.ai"
          git add ops/production/${{ env.SERVICE_NAME }}
          git commit -m "Deploy ${{ env.SERVICE_NAME }} version ${{ github.sha }}"
          git push